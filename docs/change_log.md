## 変更履歴
- 2025/06/27: DiscordのInteractionResponseEditでHTTP 500エラーが発生した場合に、ユーザーに「返事の文章が長すぎたみたい…」というメッセージを送信するように修正。
- 2025/06/27: TDDによるリファクタリングを実施。
    - `discord/embeds.go`: `SplitToEmbedFields` 関数をリファクタリングし、ネストした複雑なロジックを解消。可読性と保守性を向上させた。
    - `discord/embeds_test.go`: マルチバイト文字に関するテストケースが意図通りに動作していなかった問題を修正。テストケースをより明確なものに変更した。
- 2025/06/24: `model.json` のプロンプト読み込み処理を修正。
    - `chat/chat.go`: `GetResponse` 関数が、ユーザー固有のプロンプトを `model.json` から正しく読み込むように修正。従来は `custom_model.json` のみを參照していた問題を解決。
- 2025/05/27: リファクタリング：設定管理の改善。
    - `config/config.go`:
        - `json/custom_model.json` の読み込み処理を追加し、すべての設定ファイル (`.env`, `json/model.json`, `json/custom_model.json`) の読み込みをここに集約。
        - `CustomPromptConfig` 構造体を `discord/types.go` から移動。
        - `Config` 構造体に `CustomModel *CustomPromptConfig` フィールドを追加。
    - `discord/types.go`:
        - `CustomPromptConfig` の定義を削除 (config パッケージへ移動)。
        - ファイル自体が不要になったため削除。
    - `discord/custom_prompt.go`:
        - `config.CustomPromptConfig` を使用するように変更。
        - `GetCustomPromptForUser` が `*config.Config` を引数に取るように変更。
        - `loadCustomPrompts` 関数を `loadCustomPromptsFromFile` にリネームし、ファイル直接読み込みのヘルパー関数として位置づけを変更。
    - `discord/chat_command.go`:
        - `GetCustomPromptForUser` の呼び出し方を変更し、`*config.Config` を渡すように修正。
    - `discord/edit_command.go`:
        - `editCommandHandler` の引数を `chat.Service` から `*config.Config` に変更。
    - `discord/handler.go`:
        - `interactionCreate` ハンドラ内で `editCommandHandler` を呼び出す際の引数を `*config.Config` に変更。
    - その他: DuckDBのロックファイル競合エラーのトラブルシューティングを実施。
- 2025/05/22: - 機能追加：DMでの応答機能を追加しました。
      - BotにDMを送信すると、LLMが応答を生成して返信するようになりました。
    - 修正：サーバー内コマンド実行時にDMからのインタラクションを考慮していなかった不具合を修正しました。
    - その他：コード内の不要なコメントを削除しました。
- 2025/05/18: Botが現在日時を正しく認識できるように修正（再修正）。
    - `chat/prompt.go`: `buildFullInput` 関数で、日時情報をシステムプロンプトの直後に挿入するように変更。
- 2025/05/18: `model.json` の動的読み込みを廃止し、起動時に一度だけ読み込むように変更。
    - `config/config.go`: `Config` 構造体に `Model` フィールドを追加し、`LoadConfig` で `model.json` を読み込むように変更。
    - `chat/chat.go`: `NewChat` で `config.Config` を受け取り、保持している `ModelConfig` を使用するように変更。`GetResponse` での `model.json` の都度読み込みを削除。
    - `discord/handler.go`: `setupHandlers` と各コマンドハンドラ (`chatCommandHandler`, `aboutCommandHandler`) が `config.Config` を受け取り、そこから `ModelConfig` を利用するように変更。
    - `discord/discord.go`: `StartBot` で `setupHandlers` に `config.Config` を渡すように変更。
- 2025/05/16: 監査ログから `edited_timestamp` を削除し、`timestamp` に統一。
    - `history/audit_log.go`: `AuditLogEntry` 構造体から `EditedTimestamp` フィールドを削除し、`LogMessageUpdate` 関数を修正。
    - `discord/handler.go`: `LogMessageUpdate` 関数の呼び出し箇所を修正。
- 2025/05/16: アプリケーション終了時のシグナルハンドリングを修正し、Ctrl+Cを1回で正常に停止するように改善。
    - `main.go`: シグナルハンドリング処理をここに一本化。`discord.StartBot` のエラーハンドリングを修正。
    - `discord/discord.go`: 不要なシグナルハンドリング処理を削除し、`StartBot` 関数がブロックし続けるように修正。
- 2025/05/16: Webサイト閲覧機能 (Function Calling) のログ出力に関する改善。
    - `chat/chat.go`:
        - `curl` コマンド実行時のエラーログに出力される標準エラー出力の長さを制限。
        - Function Calling の結果としてLLMに渡される、またログに出力されるWebサイトの抽出テキストの長さを適切な値に制限。
        - ログに出力されるFunction Callingの各処理ステップの内容を、詳細な全文表示から概要表示に変更。
        - ログに出力されるテキストから不要な空白文字（改行、タブ、連続スペースなど）を除去するように修正。
    - `chat/url_reader_service.go`:
        - `curl` コマンド実行時のエラーログに出力される標準エラー出力の長さを制限。
        - Function Calling の結果として返される抽出テキストの最大長を短縮。
    - `discord/url_reader_command.go`: (このファイルは以前の修正で削除されているため、実際には変更なし。ただし、関連機能のログ改善の一環として記載)
        - `curl` コマンド実行時のエラーログに出力される標準エラー出力の長さを制限。
- 2025/05/16: URLの内容を読み取り要約する機能をFunction Callingとして実装。
    - `chat/url_reader_service.go` を新規作成し、URL取得・パース処理を実装。
    - `chat/chat.go` に `URLReaderService` を組み込み、`get_url_content` 関数をツールとして登録。Function Calling時の処理ロジックを修正。
    - `chat/prompt.go` の `toolInstructions` に `get_url_content` 関数の説明を追加。
    - 不要になった `/url-reader` スラッシュコマンド関連のコード (`discord/url_reader_command.go`, `discord/discord.go` および `discord/handler.go` の一部) を削除。
- 2025/05/16: DuckDBの履歴管理機能を変更。履歴追加時に古いデータを削除せず全て保存し、履歴取得時に最新20ペアを返すように変更。
    - `history/duckdb_manager.go` の `Add` メソッドと `Get` メソッドを修正。
- 2025/05/15: 不要になったSQLite関連のコードとドキュメントを削除。
    - `history/sqlite_manager.go` を削除 (空ファイルで上書き)。
    - `go mod tidy` を実行し、`github.com/mattn/go-sqlite3` の依存関係を削除。
    - `docs/ddd_document.md` からSQLiteに関する記述を削除。
- 2025/05/15: チャット履歴のデータベースをSQLiteからDuckDBに変更。
    - `history/duckdb_manager.go` を新規作成。
    - `discord/handler.go` で `NewDuckDBHistoryManager` を使用するように変更。
    - `go.mod` に `github.com/marcboeker/go-duckdb` を追加。
    - `docs/ddd_document.md` の関連記述を更新。
- 2025/05/15: LLMに日付と時刻の情報を渡すように修正。`chat/chat.go` と `chat/prompt.go` を変更。
- 2025/05/15: `discord/discord.go` の `StartBot` 関数における構文エラーを修正し、`HistoryManager` が意図せず早期にクローズされる問題を解決。会話履歴が正しく永続化されるように改善。エラーハンドリングとログ出力を強化し、`session.Close()` が確実に呼ばれるように修正。
- 2025/05/15: Discord Botにスレッド単位での会話履歴管理機能を追加。
    - スレッドIDまたはチャンネルIDをキーとして、SQLiteデータベースに会話履歴を永続化。
    - `/reset` コマンドで、実行されたスレッド/チャンネルの履歴を全ユーザー分削除するように変更。
    - 関連するパッケージ (`history`, `chat`, `discord`) を修正。
- 2025/05/15: エラーログを `app.log` から `error.log` に出力するように変更。
- 2025/05/02: `discord/embeds.go` の `splitToEmbedFields` を修正し、マルチバイト文字が分割されて文字化けする問題を解消。
- 2025/04/02: `/chat`, `/about` コマンド実行時に `model.json` を読み込むように変更。
- 2025/04/02: Gemini API 429 エラー時に `secondary_model_name` で再試行し、Ollama へフォールバックする機能を追加。`loader.ModelConfig` に `SecondaryModelName` フィールドを追加。
- 2025/04/02: `discord/embeds.go` の `splitToEmbedFields` を修正し、1024文字を超える場合に複数のフィールドに分割して表示するように変更。
- 2025/04/02: `chat/chat.go` に Ollama と Gemini の処理分岐を追加。`chat/ollama.go` の履歴追加処理を有効化。
- 2025/04/02: `discord/embeds.go` の `splitToEmbedFields` を修正し、1024文字を超える場合に省略表示するように変更。Discordの文字数制限エラーに対応。
- 2025/04/02: `discord/embeds.go` の `splitToEmbedFields` を修正し、Embedフィールド名を空にして非表示に変更。
- 2025/04/01: `chat/chat.go` 内の冗長なデバッグログ出力をコメントアウトし、ログ量を削減。
- 2025/04/01: コード中のコメントの表現を丁寧語から簡潔な記述に修正。
