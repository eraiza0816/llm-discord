# 作業仕様書：Discord Botにおけるスレッド単位での会話履歴管理機能の実装

## 1. 背景と目的

現状のDiscord Bot（LLM: Geminiを利用）では、複数のスレッドでユーザーと対話を行う際、会話履歴が一元的に管理されている、あるいは各対話が独立しているため、スレッドを跨いだ場合に過去の文脈の参照が困難になる可能性があります。

本機能は、Discordの各スレッド単位で会話履歴を独立して管理することにより、以下の目的を達成します。

各スレッドにおける会話の文脈（コンテキスト）の正確な維持
ユーザーとの対話における連続性と一貫性の向上
特定トピックに関する議論の深化と、より精度の高い応答の実現

## 2. 機能要件

スレッド別履歴管理: Discordの各スレッドIDを識別子とし、それぞれのスレッド内でのLLM（Gemini）との会話履歴を独立して保存・管理する。
コンテキスト連携: ユーザーからのメッセージを処理する際、該当スレッドの過去の会話履歴を取得し、LLMへの入力（プロンプト/コンテキスト）に含めて送信する。
履歴の永続化: 保存された会話履歴は、Botアプリケーションの再起動や予期せぬ停止後も失われることなく維持されるように永続化する。
スレッド未使用時の動作: スレッドを使用していない通常のチャンネルでのLLM Bot呼び出し時も、従来通り機能する。この場合、チャンネルID単位での履歴管理は行わない（あるいは、チャンネルIDをスレッドIDと同様に扱うかを別途検討）。

## 3. 実装方針案

管理主体: 会話履歴の管理は、Botアプリケーション側（discordgoで実装されたBot）で行う。
理由:
LLM API（Gemini）は基本的にステートレスであり、API側での履歴保持は一般的ではないため。
Bot側で管理することにより、Discordプラットフォーム特有の概念（Thread ID）と柔軟に連携可能であり、状態管理のロジックをBotアプリケーション内で完結できるため。

データストレージ: 会話履歴データは、SQLiteデータベースに保存する。
理由:

データの永続性を確保し、Botの再起動時にも履歴を復元可能とするため。
SQLiteはファイルベースで導入が容易であり、外部データベースサーバーのセットアップが不要なため、Botアプリケーションへの組み込みに適しているため。
Go言語（discordgo）との親和性が高く、標準ライブラリや既存のドライバを利用して容易に連携できるため。

スキーマ案（例）:
thread_histories テーブル
thread_id (TEXT PRIMARY KEY): DiscordのスレッドID
history_json (TEXT): 会話履歴（例: ユーザーの発言、Botの応答のリストをJSON形式でシリアライズしたもの）
last_updated_at (TIMESTAMP): 最終更新日時

処理フロー:
ユーザーからのメッセージをDiscord Botが受信。
メッセージが付随するスレッドのIDを取得。
スレッドIDをキーとして、SQLiteデータベースから当該スレッドの会話履歴を検索・取得。
取得した会話履歴と新規メッセージを統合し、LLM（Gemini）への入力プロンプトを生成。
LLMからの応答を受信後、新規メッセージとLLMの応答を当該スレッドの会話履歴に追加し、データベースを更新。


## 4. 期待される効果

各スレッドにおける会話の文脈理解度が向上し、より自然で的確な応答が可能になる。
ユーザー体験の向上（「前の話覚えてる？」といった確認の手間削減、より深い対話の実現）。
特定の話題やプロジェクトに関する議論がスレッド内で完結し、継続性が保たれる。

## 5. その他

使用技術（想定）:
Botフレームワーク: discordgo
LLM: Gemini API
データベース: SQLite

エラーハンドリング、データバックアップ戦略についても別途検討が必要です。
履歴リセット機能: 特定のスレッドの会話履歴のみをリセットする機能を提供する。
