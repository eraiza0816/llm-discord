# MCPサーバー連携ガイド

このドキュメントは、LLM Discord BotとMCPサーバーを連携させるための手順と注意点をまとめたものです。

## MCPサーバーとは

MCP (Model Context Protocol) サーバーは、LLM Discord Botの機能を拡張するための外部サーバーです。
MCPサーバーは、特定のタスクを実行するためのツールや、情報源となるリソースを提供します。
これにより、LLM Discord Botはより多様なリクエストに対応できるようになります。

## 連携の概要

LLM Discord BotとMCPサーバーの連携は、以下のステップで行われます。

1. **MCPサーバーの実装**:
   - 既存のMCPサーバーを利用するか、新規にMCPサーバーを開発します。
   - 新規に開発する場合、通常は `/root/Cline/MCP` ディレクトリ配下にプロジェクトを作成します。
   - サーバーは、Node.js (TypeScript) で実装されることが一般的です。
   - 必要なAPIキーや認証情報は、環境変数経由でMCPサーバーに渡されるように設計します。

2. **MCPサーバーのビルド**:
   - TypeScriptで実装されたMCPサーバーは、JavaScriptにコンパイル（ビルド）する必要があります。
   - `npm run build` コマンドなどでビルド処理を実行します。

3. **MCP設定ファイルへの登録**:
   - LLM BotがMCPサーバーを認識できるように、設定ファイルにMCPサーバーの情報を登録します。
   - 設定ファイルの管理方法にはいくつかの選択肢があります。
     - **プロジェクト固有の設定ファイル**: プロジェクト内の設定ファイル（例: `config/mcp_settings.json`）でMCPサーバー情報を管理します。LLM Botはこのファイルを直接読み込みます。VSCode環境とは独立して設定を管理したい場合に適しています。
     - **VSCode設定ファイルの参照**: VSCodeで使用しているMCPサーバー設定（通常 `/root/.vscode-server/data/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json`）をLLM Botが直接参照します。VSCode環境と設定を共通化したい場合に便利です。
     - **設定の同期**: プロジェクト固有の設定ファイルとVSCodeの設定ファイルを併用し、同期する仕組みを導入することも考えられます。これにより、両方の環境で最新の設定を利用できますが、同期メカニズムの実装が必要になります。
   - いずれの方法でも、`mcpServers` オブジェクト内に、新しいサーバーの設定を追加します。設定には、サーバーの起動コマンド、引数、環境変数（APIキーなど）を含めます。
   - 新規サーバーはデフォルトで `disabled=false` および `autoApprove=[]` と設定します。

4. **MCPサーバーの起動と接続確認**:
   - LLM Botは起動時に指定されたMCP設定ファイル（プロジェクト固有またはVSCodeの設定ファイル）を読み込み、登録されているMCPサーバーを起動し、接続を試みます。
   - 接続に成功すると、MCPサーバーが提供するツールやリソースがLLM Discord Botから利用可能になります。
   - 接続エラーが発生した場合は、ビルドパスの誤りなどが原因として考えられるため、設定ファイルやサーバーの実装を確認します。

## MCPサーバー実装時の注意点

- **非対話型環境**: MCPサーバーは非対話型環境で動作するため、実行中にユーザー入力を求めることはできません。OAuthフローの開始やブラウザウィンドウの表示も不可能です。
- **認証情報**: APIキーなどの認証情報は、MCP設定ファイルを通じて環境変数としてサーバーに渡す必要があります。
- **ツールとリソース**: MCPサーバーは、ツール（実行可能な機能）とリソース（データソース）を提供できます。一般的には、動的なパラメータを扱えるツールの方が柔軟性が高いため、ツールの利用が推奨されます。

## 既存のMCPサーバーの編集

- 既存のMCPサーバーに機能を追加・変更することも可能です。
- サーバーのソースコードがローカルに存在する場合（MCP設定ファイルの引数からパスが特定できる場合）、ファイルを直接編集して機能を変更できます。
- インストール済みのパッケージとして動作しているMCPサーバーの場合は、新規にMCPサーバーを作成する方が適切な場合があります。

## MCPサーバーが不要な場合

- すべてのタスクでMCPサーバーが必要なわけではありません。
- LLM Discord Botが標準で持つツールや機能で対応可能な場合は、MCPサーバーの実装は不要です。
- MCPサーバーの実装は、ユーザーから明示的に「〇〇するツールを追加して」といったリクエストがあった場合に検討します。

## 既存のFunction Calling実装へのMCPサーバーツールの組み込み

LLM Discord Bot (llm-discord-go) の既存のFunction Calling機能 (Gemini APIのTools機能を利用) にMCPサーバー経由のツールを組み込む手順の概要は以下の通りです。

1.  **MCPクライアントの実装**:
    *   MCPサーバーと通信するためのクライアントを `chat/` ディレクトリなどに実装します。
    *   このクライアントは、指定されたMCP設定ファイル（例: `config/mcp_settings.json` やVSCodeのMCP設定ファイル）を読み込み、登録されている各MCPサーバーへの接続を管理します。
    *   各MCPサーバーから利用可能なツールの一覧と、それぞれのツールの定義（Function Declarationに相当する情報、入力スキーマなど）を取得する機能を提供します。

2.  **`chat/chat.go` の修正**:
    *   `NewChat` 関数内で、実装したMCPクライアントを初期化します。
    *   MCPクライアント経由で、接続されている全MCPサーバーからツールの定義を取得します。
    *   取得したMCPツールの定義を、既存の `weatherService` や `urlReaderService` のFunction Declarationと同様に、`genai.Tool` の `FunctionDeclarations` リストに追加します。これにより、LLMはMCPサーバーのツールも認識できるようになります。

3.  **Function Call処理の拡張**:
    *   `Chat` 構造体の `GetResponse` メソッド内で、`genai.FunctionCall` が発生した場合の処理を拡張します。
    *   呼び出された関数名 (`fn.Name`) がMCPサーバーによって提供されたツールのものであるかを判定します。
    *   MCPサーバーのツールである場合、MCPクライアントを通じて該当するMCPサーバーにツール実行リクエストを送信します。リクエストには、関数名と引数 (`fn.Args`) を含めます。
    *   MCPサーバーからの実行結果を受け取り、`toolResult` として後続の処理（LLMへの再問い合わせなど）に渡します。

4.  **設定ファイルの更新**:
    *   `config/config.go` や関連する設定構造体に、MCP設定ファイルのパスを定義するフィールドを追加する必要があるかもしれません。
    *   LLM Bot起動時に、この設定パスを読み込み、MCPクライアントの初期化に利用します。

この手順により、既存のFunction Callingの仕組みを活かしつつ、MCPサーバーを通じて提供される多様なツールをLLM Discord Botから利用できるようになります。
